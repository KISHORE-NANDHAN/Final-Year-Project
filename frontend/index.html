<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Listening & Speaking</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body {
  font-family: Arial, sans-serif;
  background: #ffffff;
  margin: 0;
  padding: 0;
}

.tabs {
  padding: 15px 30px;
  display: flex;
  gap: 25px;
  font-size: 15px;
}

.tabs span {
  cursor: pointer;
  color: #444;
}

.tabs .active {
  color: #ff4d4d;
  border-bottom: 3px solid #ff4d4d;
  padding-bottom: 5px;
}

hr {
  border: none;
  border-top: 1px solid #ddd;
}

.container {
  padding: 30px;
  max-width: 800px;
}

h1 {
  font-size: 28px;
  margin-bottom: 20px;
}

.question p {
  margin-top: 8px;
  color: #555;
}

.audio-box {
  margin: 25px 0;
  height: 120px;
  background: #f3f4f6;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.audio-icon {
  font-size: 30px;
  color: #555;
}

.controls {
  display: flex;
  align-items: center;
  gap: 20px;
}

.start {
  background: #ff4d4d;
  border: none;
  color: white;
  padding: 10px 22px;
  font-size: 15px;
  border-radius: 6px;
  cursor: pointer;
}

.device {
  color: #444;
  cursor: pointer;
}

.recording {
  margin-top: 15px;
  background: #eaf4ff;
  padding: 12px;
  border-radius: 6px;
  color: #0056b3;
}

.stop {
  margin-top: 15px;
  background: white;
  border: 1px solid #ccc;
  padding: 10px 18px;
  border-radius: 6px;
  cursor: pointer;
}

.result {
  margin-top: 20px;
  background: #f8f9fa;
  padding: 15px;
  border-radius: 6px;
  font-size: 14px;
}

.hidden {
  display: none;
}

  </style>
</head>
<body>

<!-- Top Tabs -->
<div class="tabs">
  <span class="active">üéß Listening & Speaking</span>
  <span>‚úçÔ∏è Fill in the Blanks</span>
  <span>üìò Paragraph Reading</span>
  <span>üé§ Topic Speaking</span>
</div>

<hr />

<!-- Main Container -->
<div class="container">

  <h1>Listening & Speaking</h1>

  <!-- Question -->
  <div class="question">
    <strong>Q1: Listen and repeat</strong>
    <p>
      To develop good communication skills, you need to listen carefully to the other person.
    </p>
  </div>

  <!-- Audio Box -->
  <div class="audio-box">
    <div class="audio-icon">üîä</div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <button id="startBtn" class="start">START</button>
    <span class="device">SELECT DEVICE</span>
  </div>

  <!-- Recording Status -->
  <div id="recordingStatus" class="recording hidden">
    üéôÔ∏è Recording... Speak now!
  </div>

  <!-- Stop Button -->
  <button id="stopBtn" class="stop hidden">‚¨õ Stop Recording</button>

  <!-- Result -->
  <div id="result" class="result hidden"></div>

</div>

<script src="script.js"></script>
<script>
    let mediaRecorder;
let audioChunks = [];

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const recordingStatus = document.getElementById("recordingStatus");
const resultBox = document.getElementById("result");

startBtn.onclick = async () => {
  audioChunks = [];

  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream);

  mediaRecorder.start();

  recordingStatus.classList.remove("hidden");
  stopBtn.classList.remove("hidden");

  mediaRecorder.ondataavailable = event => {
    audioChunks.push(event.data);
  };
};

stopBtn.onclick = async () => {
  mediaRecorder.stop();
  recordingStatus.classList.add("hidden");
  stopBtn.classList.add("hidden");

  mediaRecorder.onstop = async () => {
    const audioBlob = new Blob(audioChunks, { type: "audio/wav" });

    const formData = new FormData();
    formData.append("audio", audioBlob, "response.wav");

    resultBox.classList.remove("hidden");
    resultBox.innerHTML = "‚è≥ Evaluating your response...";

    try {
      const response = await fetch(
        "http://127.0.0.1:5000/api/communication/evaluate",
        {
          method: "POST",
          body: formData
        }
      );

      const data = await response.json();

      resultBox.innerHTML = `
        <strong>Transcript:</strong> ${data.transcript}<br><br>
        <strong>Scores:</strong><br>
        Fluency: ${data.scores.fluency}<br>
        Grammar: ${data.scores.grammar}<br>
        Pronunciation: ${data.scores.pronunciation}<br>
        <strong>Final Score:</strong> ${data.scores.final_score}<br><br>
        <strong>Feedback:</strong> ${data.feedback}
      `;
    } catch (err) {
      resultBox.innerHTML = "‚ùå Error evaluating response.";
    }
  };
};

</script>
</body>
</html>
